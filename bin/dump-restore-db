#!/usr/bin/env bash

LOCAL_DUMP_PATH=~/backup/dumps

[[ " $@ " =~ ( -p | --prod | --production ) ]] && server="prod" || server="dev"
if [[ $server == "dev" ]]; then
    SERVERNAME="itresume-dev"
else
    SERVERNAME="itresume-prod"
fi


if [[ " $@ " =~ ( --wb ) ]]; then
    DB_NAME="wb"
    DB_USER="wb_admin"
    WORKDIR="wb-backend"
    if [[ $server == "prod" ]]; then
        SERVERNAME="salesify"
    fi
elif [[ " $@ " =~ ( --lms ) ]]; then
    DB_NAME="lms_db"
    LOCAL_DB_NAME="lms"
    DB_USER="lms_admin"
    WORKDIR="lms-server"
    if [[ $server == "prod" ]]; then
        DB_NAME="lms"
        SERVERNAME="itresume-corp"
    fi
else
    echo "DB was not selected, exiting"
    exit
fi

FULLPATH="$LOCAL_DUMP_PATH/${DB_NAME}-${server}.sql"
if ! [[ -v LOCAL_DB_NAME ]]; then
    LOCAL_DB_NAME=$DB_NAME
fi

if ! [[ " $@ " =~ ( -l | --local-dump ) ]]; then
    echo "Enter password for ${SERVERNAME^^} ${DB_NAME^^} database"
    ssh $SERVERNAME "pg_dump -h localhost -U $DB_USER -d $DB_NAME -W | gzip -9" > "$FULLPATH.gz"
fi


if [[ " $@ " =~ ( -u | --update ) ]]; then
    gzip -dkf "$FULLPATH.gz"
    sudo -u postgres psql << EOF
        DROP DATABASE $LOCAL_DB_NAME;
        CREATE DATABASE $LOCAL_DB_NAME;
EOF
    psql -d $LOCAL_DB_NAME < $FULLPATH
    rm -f "$FULLPATH"

    if [[ " $@ " =~ ( --lms ) ]]; then
        bash ~/repos/itresume/$WORKDIR/scripts/rename_apps.sh
    fi
    ~/repos/itresume/$WORKDIR/.venv/bin/python ~/repos/itresume/$WORKDIR/manage.py migrate
    if [[ " $@ " =~ ( --lms ) ]]; then
        cd ~/repos/itresume/$WORKDIR
        ~/repos/itresume/$WORKDIR/.venv/bin/python ~/repos/itresume/$WORKDIR/scripts/transfer_data.py
    fi
fi


# if [[ " $@ " =~ ( --itresume ) && $is_production == 1 ]]; then
#     if [[ $use_local == 0 ]]; then
#         ssh itresume-prod "mysqldump --single-transaction --skip-lock-tables -u root -p production | gzip -9" > "$LOCAL_DUMP_PATH/itresume-prod.sql.gz"
#     fi
